name: AmazonLinux Base Image Build
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 6' # Weekly on Saturday at 00:00

jobs:
  ci:
    name: Build Image and Push
    runs-on: self-hosted
    steps:
      # https://github.com/docker/login-action#quayio
      - name: Login to Quay.io
        uses: docker/login-action@v2
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_ROBOT_TOKEN }}

      # https://github.com/docker/login-action#aws-public-elastic-container-registry-ecr
      - name: Login to ECR
        uses: docker/login-action@v2
        env:
          AWS_REGION: "us-east-1"

      - name: Checkout
        uses: actions/checkout@v3
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v3
        with:
          images: |
            quay.io/cdis/amazonlinux:${{ env.IMAGE_TAG }}
            ${{ inputs.AWS_ECR_REGISTRY }}/gen3/amazonlinux:${{ env.IMAGE_TAG }}


      - name: Build and push (Quay only)
        if: ${{ inputs.USE_QUAY_ONLY }}
        uses: docker/build-push-action@v3
        with:
          context: ${{ inputs.DOCKERFILE_BUILD_CONTEXT }}
          file: ${{ inputs.DOCKERFILE_LOCATION }}
          push: true
          tags: |
            quay.io/cdis/${{ env.REPO_NAME }}:${{ env.IMAGE_TAG }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=quay.io/cdis/${{ env.REPO_NAME }}:${{ env.IMAGE_TAG }}
          cache-to: type=inline
          platforms: "linux/amd64, linux/arm64"
